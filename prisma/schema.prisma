generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                  String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName            String                   @map("full_name")
  email               String                   @unique
  phone               String?                  @unique
  nic                 String?                  @unique
  residentialAddress  String?                  @map("residential_address")
  passwordHash        String                   @map("password_hash")
  isActive            Boolean                  @default(true) @map("is_active")
  createdAt           DateTime                 @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt           DateTime                 @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  customerBookings    bookings[]               @relation("BookingCustomer")
  createdBookings     bookings[]               @relation("BookingCreator")
  bookingStatusEvents booking_status_history[] @relation("BookingStatusChangedBy")
  counterTransactions counter_transactions[]
  notifications       notifications[]
  ownedProperties     properties[]             @relation("PropertyOwner")
  createdPayments     payments[]               @relation("PaymentCreatedBy")
  payments            payments[]               @relation("PaymentPayer")
  roles               user_roles[]
  vehicles            vehicles[]
  washJobs            wash_jobs[]              @relation("WashJobWasher")

  @@index([email])
  @@map("users")
}

model roles {
  id    Int       @id @default(autoincrement()) @db.SmallInt
  name  RoleName  @unique
  users user_roles[]

  @@map("roles")
}

model user_roles {
  userId String @db.Uuid @map("user_id")
  roleId Int    @db.SmallInt @map("role_id")
  role   roles  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
  @@map("user_roles")
}

model properties {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId           String          @db.Uuid @map("owner_id")
  propertyName      String          @map("property_name")
  address           String
  pricePerHour      Decimal         @default(0) @db.Decimal(10, 2) @map("price_per_hour")
  pricePerDay       Decimal         @default(0) @db.Decimal(10, 2) @map("price_per_day")
  currency          String          @default("LKR")
  status            PropertyStatus  @default(NOT_ACTIVATED)
  totalSlots        Int             @default(0) @map("total_slots")
  totalNormalSlots  Int             @default(0) @map("total_normal_slots")
  totalEvSlots      Int             @default(0) @map("total_ev_slots")
  totalCarWashSlots Int             @default(0) @map("total_car_wash_slots")
  createdAt         DateTime        @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt         DateTime        @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  bookings          bookings[]
  owner             users           @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  parkingSlots      parking_slots[]

  @@index([ownerId])
  @@index([status])
  @@map("properties")
}

model parking_slots {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId   String        @db.Uuid @map("property_id")
  slotNumber   String        @map("slot_number")
  slotType     SlotType      @map("slot_type")
  isActive     Boolean       @default(true) @map("is_active")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  bookingSlots booking_slots[]
  property     properties    @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, slotNumber])
  @@index([propertyId])
  @@index([slotType])
  @@map("parking_slots")
}

model vehicles {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @db.Uuid @map("user_id")
  vehicleNumber String    @unique @map("vehicle_number")
  type          String?
  model         String?
  color         String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  bookings      bookings[]
  user          users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("vehicles")
}

model bookings {
  id              String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId      String                   @db.Uuid @map("customer_id")
  propertyId      String                   @db.Uuid @map("property_id")
  vehicleId       String?                  @db.Uuid @map("vehicle_id")
  startTime       DateTime                 @db.Timestamptz(6) @map("start_time")
  endTime         DateTime                 @db.Timestamptz(6) @map("end_time")
  status          BookingStatus            @default(PENDING)
  parkingType     SlotType                 @default(NORMAL) @map("parking_type")
  bookingType     String                   @default("NORMAL") @map("booking_type")
  createdBy       String?                  @db.Uuid @map("created_by")
  createdAt       DateTime                 @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt       DateTime                 @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  bookingSlots    booking_slots[]
  customer        users                    @relation("BookingCustomer", fields: [customerId], references: [id], onDelete: Restrict)
  creator         users?                   @relation("BookingCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  counterLogs     counter_transactions[]
  paymentSummary  payment_summary?
  payments        payments[]
  property        properties               @relation(fields: [propertyId], references: [id], onDelete: Restrict)
  statusHistory   booking_status_history[]
  vehicle         vehicles?                @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([propertyId])
  @@index([vehicleId])
  @@index([status])
  @@index([startTime, endTime])
  @@index([createdBy])
  @@map("bookings")
}

model booking_slots {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookingId   String        @db.Uuid @map("booking_id")
  slotId      String        @db.Uuid @map("slot_id")
  createdAt   DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  booking     bookings      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  slot        parking_slots @relation(fields: [slotId], references: [id], onDelete: Restrict)
  washJob     wash_jobs?

  @@unique([bookingId, slotId])
  @@index([slotId])
  @@map("booking_slots")
}

model booking_status_history {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookingId String    @db.Uuid @map("booking_id")
  oldStatus String?   @map("old_status")
  newStatus String    @map("new_status")
  changedBy String?   @db.Uuid @map("changed_by")
  note      String?
  changedAt DateTime  @default(now()) @db.Timestamptz(6) @map("changed_at")
  booking   bookings  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  changer   users?    @relation("BookingStatusChangedBy", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([bookingId, changedAt])
  @@index([changedBy])
  @@map("booking_status_history")
}

model payment_summary {
  bookingId   String   @id @db.Uuid @map("booking_id")
  totalAmount Decimal  @default(0) @db.Decimal(10, 2) @map("total_amount")
  onlinePaid  Decimal  @default(0) @db.Decimal(10, 2) @map("online_paid")
  cashPaid    Decimal  @default(0) @db.Decimal(10, 2) @map("cash_paid")
  balanceDue  Decimal  @default(0) @db.Decimal(10, 2) @map("balance_due")
  currency    String   @default("LKR")
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  booking     bookings @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payment_summary")
}

model payments {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookingId      String        @db.Uuid @map("booking_id")
  payerId        String        @db.Uuid @map("payer_id")
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("LKR")
  method         PaymentMethod
  paymentStatus  PaymentStatus @default(UNPAID) @map("payment_status")
  gatewayStatus  GatewayStatus @default(PENDING) @map("gateway_status")
  gatewayProvider String?      @map("gateway_provider")
  transactionId  String?       @map("transaction_id")
  cardLast4      String?       @map("card_last4")
  cardBrand      String?       @map("card_brand")
  cardExpMonth   Int?          @map("card_exp_month")
  cardExpYear    Int?          @map("card_exp_year")
  paidAt         DateTime?     @db.Timestamptz(6) @map("paid_at")
  createdBy      String?       @db.Uuid @map("created_by")
  createdAt      DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  booking        bookings      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  creator        users?        @relation("PaymentCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  payer          users         @relation("PaymentPayer", fields: [payerId], references: [id], onDelete: Restrict)

  @@index([bookingId])
  @@index([paymentStatus])
  @@index([payerId])
  @@index([bookingId, paymentStatus])
  @@map("payments")
}

model wash_jobs {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookingSlotId String      @unique @db.Uuid @map("booking_slot_id")
  washerId      String?     @db.Uuid @map("washer_id")
  status        WashStatus  @default(PENDING)
  acceptedAt    DateTime?   @db.Timestamptz(6) @map("accepted_at")
  completedAt   DateTime?   @db.Timestamptz(6) @map("completed_at")
  note          String?
  createdAt     DateTime    @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt     DateTime    @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")
  bookingSlot   booking_slots @relation(fields: [bookingSlotId], references: [id], onDelete: Cascade)
  washer        users?      @relation("WashJobWasher", fields: [washerId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([washerId, status])
  @@map("wash_jobs")
}

model counter_transactions {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  counterUserId String   @db.Uuid @map("counter_user_id")
  bookingId     String   @db.Uuid @map("booking_id")
  action        String
  note          String?
  createdAt     DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  booking       bookings @relation(fields: [bookingId], references: [id], onDelete: Restrict)
  counterUser   users    @relation(fields: [counterUserId], references: [id], onDelete: Restrict)

  @@index([counterUserId])
  @@index([bookingId])
  @@map("counter_transactions")
}

model notifications {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  title     String
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum BookingStatus {
  PENDING
  PAID
  CANCELLED
}

enum SlotType {
  NORMAL
  EV
  CAR_WASH
}

enum WashStatus {
  PENDING
  ACCEPTED
  COMPLETED
}

enum PaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

enum GatewayStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentMethod {
  CARD
  CASH
}

enum PropertyStatus {
  ACTIVATED
  NOT_ACTIVATED
}

enum RoleName {
  ADMIN
  CUSTOMER
  LANDOWNER
  WASHER
  COUNTER
}
